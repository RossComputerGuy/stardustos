#!/usr/bin/env bash

set -e
if ! [ -d @PACKAGE_BINARY_DIR@/build ]; then
	ln -s @PACKAGE_SOURCE_DIR@/src @PACKAGE_BINARY_DIR@/build
	cd @PACKAGE_BINARY_DIR@/build
	git checkout v@PACKAGE_VERSION@
fi
cd @PACKAGE_BINARY_DIR@/build
./configure --prefix=/usr --libdir=/lib --target=i386 CFLAGS="-m32" CROSS_COMPILE=x86_64-linux-gnu-
make
sed -i "s|/lib/|@BUILDFS@/lib/|" obj/musl-gcc
sed -i "s|/lib|@BUILDFS@/lib|" lib/musl-gcc.specs
sed -i "s|/usr|@BUILDFS@/usr|" lib/musl-gcc.specs
make install DESTDIR=@BUILDFS@
make install-libs DESTDIR=@INITRD@
rm @INITRD@/lib/musl-gcc.specs -rf