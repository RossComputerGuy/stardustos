#!/usr/bin/env bash

set -e
if ! [ -d @PACKAGE_BINARY_DIR@/build ]; then
	ln -s @PACKAGE_SOURCE_DIR@/src @PACKAGE_BINARY_DIR@/build
	cd @PACKAGE_BINARY_DIR@/build
	git checkout v@PACKAGE_VERSION@
fi
cd @PACKAGE_BINARY_DIR@/build
export CFLAGS="-m32"
export CROSS_COMPILE=x86_64-pc-linux-gnu-
export CC="${CROSS_COMPILE}gcc"
./configure --prefix=/usr --libdir=/lib --target=i386
make
sed -i "s|/lib/|@BUILDFS@/lib/|" obj/musl-gcc
cp @PACKAGE_BINARY_DIR@/musl-gcc.specs lib/musl-gcc.specs
make install DESTDIR=@BUILDFS@
make install-libs DESTDIR=@INITRD@
rm @INITRD@/lib/musl-gcc.specs -rf